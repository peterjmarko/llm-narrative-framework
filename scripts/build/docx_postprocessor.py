#!/usr/bin/env python3
#-*- coding: utf-8 -*-
#
# Personality Matching Experiment Framework
# Copyright (C) 2025 Peter J. Marko
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
# Filename: scripts/build/docx_postprocessor.py

"""
Post-processes DOCX files to insert page breaks.

This script is a utility called by the documentation build process. It scans a
DOCX file generated by Pandoc, finds a specific text marker for a page break,
and replaces it with a hard page break, ensuring correct pagination in the
final document.
"""

import os
from docx import Document
from docx.enum.text import WD_BREAK

def insert_page_breaks_by_marker(docx_path: str, marker_text: str):
    """
    Opens a DOCX file, finds paragraphs containing a specific marker text,
    inserts a page break immediately before them, and then deletes the marker paragraph.
    
    Args:
        docx_path (str): The path to the DOCX file.
        marker_text (str): The exact text string to look for as a page break marker.
    """
    if not os.path.exists(docx_path):
        print(f"      ERROR: DOCX file not found for post-processing: {docx_path}")
        return

    try:
        document = Document(docx_path)
        
        paragraphs_to_process = []
        for p in document.paragraphs:
            # Make the search resilient to Pandoc's smart typography (--- -> â€”)
            # by looking for the core, untransformed part of the marker.
            if "PAGEBREAK" in p.text:
                paragraphs_to_process.append(p)
        
        for p in paragraphs_to_process:
            # Insert a new paragraph before the marker paragraph
            new_p = p.insert_paragraph_before('')
            # Add a run to the new paragraph and insert the page break there
            run = new_p.add_run()
            run.add_break(WD_BREAK.PAGE)
            
            # Now, delete the original marker paragraph
            p._element.getparent().remove(p._element)

        document.save(docx_path)
        print(f"      INFO: Successfully inserted page breaks in '{os.path.basename(docx_path)}'.")

    except Exception as e:
        print(f"      ERROR: Failed to post-process DOCX '{os.path.basename(docx_path)}': {e}")

# === End of scripts/build/docx_postprocessor.py ===
