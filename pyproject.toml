[build-system]
requires = ["pdm-backend"]
build-backend = "pdm.backend"

[project]
name = "llm-personality-matching"
version = "5.4.1"
description = "A reproducible pipeline for LLM personality matching experiments."
authors = [
    {name = "Peter Marko", email = "peter.j.marko@gmail.com"},
]
requires-python = ">=3.11"
readme = "README.md"
license = {text = "MIT"}

dependencies = [
    "numpy",
    "pandas",
    "scipy",
    "statsmodels",
    "networkx",
    "requests>=2.32.4",
    "python-dotenv",
    "tqdm>=4.67.1",
    "seaborn",
    "matplotlib",
    "pingouin>=0.5.5",
    "python-docx", # Added for DOCX post-processing
    "thefuzz[speedup]>=0.22.1",
    "beautifulsoup4>=4.13.4",
    "certifi>=2025.8.3",
]

[tool.pdm.dev-dependencies]
dev = [
    "pytest",
    "pre-commit",
    "pypandoc>=1.15",
    "pillow>=10.4.0",
    "pytest-cov>=5.0.0",
    "pytest-mock>=3.14.1",
    "commitizen>=3.31.0",
    "python-docx>=0.8.11",
]

[tool.pdm]
# This tells PDM to use a virtual environment located in the project's .venv folder.
venv.in-project = true

[tool.pytest.ini_options]
pythonpath = ["src"]

[tool.pdm.scripts]
# Development and testing shortcuts. {args} allows passing specific files.
# This is the main entry point for all tests (Python and PowerShell).
test = {cmd = "python tests/run_all_tests.py {args}", help = "Run all tests (Python and PowerShell) with cleanup."}

# --- Definitive Coverage Workflow ---
# This is the robust, explicit workflow for subprocess testing. It has 5 steps:
# 1. Erase old data.
# 2. Use `coverage run` as the main entry point to start the test session.
# 3. Your test helper also calls `coverage run` for the subprocess.
#    (This creates parallel data files thanks to your .coveragerc)
# 4. `coverage combine` merges all parallel data into one file.
# 5. `coverage report` or `coverage html` shows the final, correct results.

# --- THE DEFINITIVE COVERAGE SCRIPTS ---
# We disable the pytest-cov plugin with `-p no:cov` to prevent it from
# interfering with our manual `coverage run` invocation.
cov = {cmd = "coverage erase && coverage run -m pytest -p no:cov && coverage report", help="Run all tests with coverage analysis."}
cov-file = {shell = "coverage erase && coverage run -m pytest -p no:cov tests/test_{args}.py && coverage report src/{args}.py", help="Run coverage for a specific file by its base name (e.g., find_wikipedia_links)."}
cov-html = {cmd = "coverage erase && coverage run -m pytest -p no:cov && coverage html", help="Run all tests and generate an HTML coverage report."}
cov-erase = {cmd = "coverage erase", help="Clean up coverage data files."}
# ------------------------------------

lint = "pre-commit run --all-files"
lint-headers = {cmd = "python scripts/lint_file_headers.py --fix ./src/*.py ./tests/*.py ./*.ps1 ./scripts/*.py", help = "Fix headers and footers on all project scripts."}
check-headers = {cmd = "python scripts/lint_file_headers.py ./src/*.py ./tests/*.py ./*.ps1 ./scripts/*.py", help = "Check headers and footers on all project scripts."}
build-docs = "python scripts/build_docs.py"

# --- Developer Workflow ---
commit = {cmd = "cz commit", help = "Create a new commit using the interactive Commitizen prompt."}
release = {cmd = "python scripts/finalize_release.py", help = "Finalize a new release (bump, changelog, tag)."}
# ------------------------

# Data preparation workflow shortcuts
prep-data = "powershell -ExecutionPolicy Bypass -File ./prepare_data.ps1"

# Main workflow shortcuts
new-exp = "powershell -ExecutionPolicy Bypass -File ./new_experiment.ps1"
aud-exp = "powershell -ExecutionPolicy Bypass -File ./audit_experiment.ps1"
fix-exp = "powershell -ExecutionPolicy Bypass -File ./fix_experiment.ps1"
mig-exp = "powershell -ExecutionPolicy Bypass -File ./migrate_experiment.ps1"
pro-stu = "powershell -ExecutionPolicy Bypass -File ./process_study.ps1"
new-stu = "powershell -ExecutionPolicy Bypass -File ./new_study.ps1"
aud-stu = "powershell -ExecutionPolicy Bypass -File ./audit_study.ps1"
fix-stu = "powershell -ExecutionPolicy Bypass -File ./fix_study.ps1"
mig-stu = "powershell -ExecutionPolicy Bypass -File ./migrate_study.ps1"

# Testing shortcuts
test-ps-exp = "pwsh ./tests/new_experiment.Tests.ps1"
test-ps-aud = "pwsh ./tests/audit_experiment.Tests.ps1"
test-ps-fix = "pwsh ./tests/fix_experiment.Tests.ps1"
test-ps-mig = "pwsh ./tests/migrate_experiment.Tests.ps1"
test-ps-pro = "pwsh ./tests/process_study.Tests.ps1"
test-ps-stu = "pwsh ./tests/new_study.Tests.ps1"
test-ps-ast = "pwsh ./tests/audit_study.Tests.ps1"
test-ps-fst = "pwsh ./tests/fix_study.Tests.ps1"
test-ps-mst = "pwsh ./tests/migrate_study.Tests.ps1"
test-ps-all = "pwsh ./tests/run_all_ps_tests.ps1"

[tool.commitizen]
name = "cz_conventional_commits"
version = "5.4.1"
version_files = [
    "pyproject.toml:version"
]
tag_format = "v$version"
changelog_file = "CHANGELOG.md"
changelog_format = "keep_a_changelog"
