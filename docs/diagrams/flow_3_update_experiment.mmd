graph TD
    %% 1. Nodes
    EntryPointPS["update_experiment.ps1<br/>(User Entry Point)"]:::entry_ps
    PreAudit["1. Audit Experiment<br/><small>calls experiment_manager.py --verify-only</small>"]:::script
    Decision{Audit Result?}:::decision
    Prompt["Prompt User<br/>'Force Update?'"]:::user_interaction
    Stop((Exit)):::stop_node
    
    subgraph "2. Reprocess Experiment"
        direction TB
        ReprocessEntry["experiment_manager.py --reprocess"]:::entry_py
        Loop["Loops over each replication"]:::process
        CallOrchestrator["Calls orchestrate_replication.py --reprocess<br/><small>Regenerates analysis artifacts (metrics JSON, report, CSV)</small>"]:::layer_green
        FinalAggregate["Final Aggregation<br/><small>Calls experiment_aggregator.py<br/>Regenerates EXPERIMENT_results.csv</small>"]:::layer_green
    end
    
    PostAudit["3. Verify Update<br/><small>calls experiment_manager.py --verify-only</small>"]:::script

    %% 2. Connections
    EntryPointPS --> PreAudit
    PreAudit --> Decision
    
    Decision -- "VALIDATED" --> Prompt
    Decision -- "NEEDS_REPROCESS" --> ReprocessEntry
    Decision -- "INVALID" --> Stop
    
    Prompt -- "Yes" --> ReprocessEntry
    Prompt -- "No" --> Stop
    
    ReprocessEntry --> Loop
    Loop --> CallOrchestrator
    CallOrchestrator --> Loop
    ReprocessEntry -- "After loop" --> FinalAggregate
    
    FinalAggregate --> PostAudit

    %% 3. Styling
    classDef entry_ps fill:#337ab7,stroke:#2e6da4,color:#fff;
    classDef script fill:#5bc0de,stroke:#46b8da,color:#fff;
    classDef decision fill:#f0ad4e,stroke:#eea236,color:#333;
    classDef user_interaction fill:#9b59b6,stroke:#8e44ad,color:#fff;
    classDef stop_node fill:#e74c3c,stroke:#c0392b,color:#fff;
    classDef entry_py fill:#1abc9c,stroke:#16a085,color:#fff;
    classDef process fill:#f1c40f,stroke:#f39c12,color:#333;
    classDef layer_green fill:#2ecc71,stroke:#27ae60,color:#fff;