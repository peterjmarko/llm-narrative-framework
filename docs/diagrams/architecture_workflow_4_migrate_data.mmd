graph TD
    %% 1. Define all nodes first
    EntryPointPS["migrate_experiment.ps1<br/>(User Entry Point)"]:::entry_ps
    EntryPointPy["experiment_manager.py<br/>(--migrate Mode)"]:::entry_py
    
    PatchOld["patch_old_experiment.py"]:::script
    RestoreConfig["restore_config.py"]:::script
    ArchivedConfig[("config.ini.archived")]:::artifact
    RebuildReports["rebuild_reports.py"]:::script
    
    LogManagerRebuild["replication_log_manager.py<br/>(rebuild command)"]:::danger
    BatchRunLog[("batch_run_log.csv")]:::artifact
    Aggregator["experiment_aggregator.py<br/>(hierarchical mode)"]:::script
    ReplResults[("REPLICATION_results.csv")]:::artifact
    ExpResults[("EXPERIMENT_results.csv")]:::artifact
    LogManagerFinalize["replication_log_manager.py<br/>(finalize command)"]:::danger
    
    FinalArtifacts[("STUDY_results.csv")]:::artifact

    %% 2. Define connections
    EntryPointPS --> EntryPointPy
    EntryPointPy -- "Orchestrates Step 1" --> PatchOld
    PatchOld --> RestoreConfig
    RestoreConfig --> ArchivedConfig
    ArchivedConfig -- "Read By" --> RebuildReports
    EntryPointPy -- "Orchestrates Step 2" --> RebuildReports
    EntryPointPy -- "Finalizes (Step 3)" --> LogManagerRebuild
    LogManagerRebuild --> BatchRunLog
    EntryPointPy -- "Finalizes (Step 3)" --> Aggregator
    Aggregator --> ReplResults
    Aggregator --> ExpResults
    Aggregator --> FinalArtifacts
    EntryPointPy -- "Finalizes (Step 3)" --> LogManagerFinalize
    LogManagerFinalize --> BatchRunLog
    
    %% No direct connection from LogManagerFinalize to FinalArtifacts anymore

    %% 3. Group nodes into subgraphs
    subgraph "Workflow 4: Migrate Old Experiment Data"
        direction TB
        EntryPointPS
        EntryPointPy
        subgraph "Migration Steps (Orchestrated by experiment_manager.py)"
            direction TB
            PatchOld
            RestoreConfig
            ArchivedConfig
            RebuildReports
        end
        subgraph "Post-Migration Finalization (Automated)"
            direction TB
            LogManagerRebuild
            BatchRunLog
            Aggregator
            ReplResults
            ExpResults
            FinalArtifacts
            LogManagerFinalize
        end
    end

    %% 4. Styling (re-using existing styles, adding new ones if needed)
    classDef entry_ps fill:#337ab7,stroke:#2e6da4,color:#fff;
    classDef entry_py fill:#f0ad4e,stroke:#eea236,color:#333;
    classDef script fill:#5bc0de,stroke:#46b8da,color:#fff;
    classDef danger fill:#d9534f,stroke:#d43f3a,color:#fff;
    classDef artifact fill:#f0f0f0,stroke:#ccc,stroke-width:2px,stroke-dasharray: 5 5;