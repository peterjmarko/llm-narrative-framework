graph TD
    subgraph "Logic for generate_ocean_scores.py"
        A[Start] --> B{Load eminence scores & ALL existing OCEAN scores};
        
        subgraph "Pre-flight Check & Resumption"
            B --> C{"Enough data for<br/>pre-flight check?"};
            C -- No --> F{Loop through remaining subjects in batches};
            C -- Yes --> D[Re-calculate benchmark variance & ALL variance checks from existing data];
            D --> E{"Is Cutoff condition met?"};
            E -- Yes --> G[Finalize data truncate/report & Exit];
            E -- No --> H[Load re-calculated state for resumption];
            H --> F;
        end

        subgraph "Main Loop"
            F --> G[Call LLM for OCEAN scores];
            G --> H{Reconcile response, log any missed subjects};
            H --> I[Append new scores to ocean_scores.csv];
            I --> J{Did new scores cross a variance_analysis_window boundary?};
            J -- No --> F;
            J -- Yes --> K{"Establish Benchmark<br/>if not set"};
            K --> L{"Is Cutoff Logic Active<br/>min subjects met?"};
            L -- No --> F;

            subgraph "Cutoff Logic (M of N)"
                L -- Yes --> M{"Window Variance<br/> < Threshold?"};
                M --> N[Update list of last N checks];
                N --> O{"Trigger Count >= M?"};
                O -- No --> F;
                O -- Yes --> Q[Break Loop];
            end
        end

        F -- End of Subjects --> R[Finalize];
        Q -- Stop --> R;
        
        subgraph "Finalization"
            R --> S{Did run complete normally?};
            S -- Yes --> T{Determine final subject count based on last trigger};
            S -- No (Interrupted) --> U{Keep all processed subjects};
            T --> V[Round down count to nearest 100];
            V --> W[Truncate main file & archive discarded scores];
            U --> W;
            W --> X[Generate Summary & Missing Scores reports];
            X --> Y[End];
        end
    end