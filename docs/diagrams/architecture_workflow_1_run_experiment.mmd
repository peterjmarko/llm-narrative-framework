graph TD
    %% 1. Define all nodes first
    EntryPoint["run_experiment.ps1<br/>(User Entry Point)"]:::entry
    BatchManager["experiment_manager.py<br/>(Manages Batch)"]:::layer_orange
    LogManager["replication_log_manager.py"]:::danger
    BatchLog[("batch_run_log.csv")]:::artifact
    FinalAggregator["experiment_aggregator.py"]:::script
    ReplResults[("REPLICATION_results.csv")]:::artifact
    ExpResults[("EXPERIMENT_results.csv")]:::artifact
    
    ReplicationOrchestrator["orchestrate_replication.py"]:::layer_green
    BuildQueries["1. build_llm_queries.py"]:::script
    QueryGenerator["query_generator.py"]:::script
    LLMQueries[("llm_query_XXX.txt")]:::artifact
    RunSessions["2. run_llm_sessions.py"]:::script
    LLMPrompter["llm_prompter.py"]:::script
    LLMResponses[("llm_response_XXX.txt")]:::artifact
    ProcessResponses["3. process_llm_responses.py"]:::script
    AllScores[("all_scores.txt")]:::artifact
    AllMappings[("all_mappings.txt")]:::artifact
    AnalyzePerformance["4. analyze_llm_performance.py"]:::script
    BiasAnalysis["5. run_bias_analysis.py"]:::script
    Aggregator["6. experiment_aggregator.py"]:::script
    ReplicationReport[("replication_report.txt")]:::artifact

    %% 2. Define connections
    EntryPoint --> BatchManager
    BatchManager -- "Calls in Loop" --> ReplicationOrchestrator
    BatchManager -- "Finalizes Batch" --> LogManager
    LogManager --> BatchLog
    
    %% The orchestrator now handles the full 6-stage replication pipeline
    ReplicationOrchestrator --> BuildQueries
    ReplicationOrchestrator --> RunSessions
    ReplicationOrchestrator --> ProcessResponses
    ReplicationOrchestrator --> AnalyzePerformance
    ReplicationOrchestrator --> BiasAnalysis
    ReplicationOrchestrator --> Aggregator

    %% Add invisible links to force the visual order of the stages
    BuildQueries ~~~ RunSessions ~~~ ProcessResponses ~~~ AnalyzePerformance ~~~ BiasAnalysis ~~~ Aggregator

    BatchManager -- "Finalizes Batch" --> FinalAggregator
    FinalAggregator --> ExpResults
    Aggregator --> ReplResults

    BuildQueries --> QueryGenerator
    BuildQueries --> LLMQueries
    LLMQueries --> RunSessions
    RunSessions --> LLMPrompter
    RunSessions --> LLMResponses
    LLMResponses --> ProcessResponses
    ProcessResponses --> AllScores
    ProcessResponses --> AllMappings
    AllScores --> AnalyzePerformance
    AllMappings --> AnalyzePerformance
    AnalyzePerformance --> ReplicationReport
    BiasAnalysis -- "Modifies" --> ReplicationReport

    %% 3. Group nodes into subgraphs using their IDs
    subgraph "Workflow 1: Run an Experiment"
        direction TB
        EntryPoint
        subgraph "Batch Management Layer"
            BatchManager
            LogManager
            BatchLog
            FinalAggregator
            ExpResults
        end
        
        subgraph "Single Replication Layer (Called in a loop)"
            ReplicationOrchestrator
            BuildQueries
            QueryGenerator
            LLMQueries
            RunSessions
            LLMPrompter
            LLMResponses
            ProcessResponses
            AllScores
            AllMappings
            AnalyzePerformance
            BiasAnalysis
            Aggregator
            ReplicationReport
            ReplResults
        end
    end

    %% 4. Styling
    classDef entry fill:#337ab7,stroke:#2e6da4,color:#fff;
    classDef layer_orange fill:#f0ad4e,stroke:#eea236,color:#333;
    classDef layer_green fill:#5cb85c,stroke:#4cae4c,color:#fff;
    classDef script fill:#5bc0de,stroke:#46b8da,color:#fff;
    classDef danger fill:#d9534f,stroke:#d43f3a,color:#fff;
    classDef artifact fill:#f0f0f0,stroke:#ccc,stroke-width:2px,stroke-dasharray: 5 5;
