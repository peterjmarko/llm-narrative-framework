graph TD;

    %% --- Style Definitions (Based on Original Palette) ---
    classDef WorkflowEntry fill:#1f77b4,stroke:#fff,stroke-width:2px,color:#fff;
    classDef ReplicationManager fill:#ff7f0e,stroke:#fff,stroke-width:2px,color:#fff;
    classDef Orchestrator fill:#2ca02c,stroke:#333,stroke-width:1px,color:#fff;
    classDef StageScript fill:#9467bd,stroke:#333,stroke-width:1px,color:#fff;
    classDef Utility fill:#d62728,stroke:#333,stroke-width:1px,color:#fff;
    classDef DataArtifact fill:#f0f0f0,stroke:#666,stroke-width:1px,stroke-dasharray: 5 5,color:#333;

    %% === Nodes & Connections for the Normal Run Workflow ===
    run_exp["run_experiment.ps1<br/><i>(User Entry Point)</i>"]:::WorkflowEntry;

    subgraph "Batch Management Layer"
        rep_man["replication_manager.py<br/><i>(Manages Batch)</i>"]:::ReplicationManager;
        log_man["log_manager.py<br/><i>(Tracks Batch Progress)</i>"]:::Utility;
        batch_log[("batch_log.txt")]:::DataArtifact;
    end
    
    subgraph "Single Replication Layer"
        orch["orchestrate_replication.py<br/><i>(Runs One Replication)</i>"]:::Orchestrator;
        stage1["1. build_queries.py"]:::StageScript;
        stage2["2. run_llm_sessions.py"]:::StageScript;
        stage3["3. process_llm_responses.py"]:::StageScript;
        stage4["4. analyze_performance.py"]:::StageScript;
        replication_report[("replication_report.txt")]:::DataArtifact;
    end

    %% --- Top Level Connections ---
    run_exp --> rep_man;
    rep_man -->|"Calls (in loop)"| orch;
    rep_man --> log_man;
    log_man -->|Produces| batch_log;

    %% --- Single Replication Connections ---
    orch --> stage1 --> stage2 --> stage3 --> stage4;
    stage4 -->|Generates| replication_report;
