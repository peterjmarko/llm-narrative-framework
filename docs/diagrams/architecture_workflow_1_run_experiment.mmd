graph TD
    %% 1. Define all nodes first
    EntryPoint["run_experiment.ps1<br/>(User Entry Point)"]:::entry
    BatchManager["experiment_manager.py<br/>(Manages Batch)"]:::layer_orange
    LogManager["replication_log_manager.py"]:::danger
    BatchLog[("batch_log.txt")]:::artifact
    
    ReplicationOrchestrator["orchestrate_replication.py"]:::layer_green
    BuildQueries["1. build_llm_queries.py"]:::script
    RunSessions["2. run_llm_sessions.py"]:::script
    ProcessResponses["3. process_llm_responses.py"]:::script
    AnalyzePerformance["4. analyze_llm_performance.py"]:::script
    ReplicationReport[("replication_report.txt")]:::artifact

    %% 2. Define connections
    EntryPoint --> BatchManager
    BatchManager -- "Calls" --> ReplicationOrchestrator
    BatchManager --> LogManager --> BatchLog
    ReplicationOrchestrator --> BuildQueries --> RunSessions --> ProcessResponses --> AnalyzePerformance --> ReplicationReport

    %% 3. Group nodes into subgraphs using their IDs
    subgraph "Overall Process"
        direction LR
        subgraph "Batch Management Layer"
            BatchManager
            LogManager
            BatchLog
        end
        
        subgraph "Single Replication Layer (Called in a loop)"
            ReplicationOrchestrator
            BuildQueries
            RunSessions
            ProcessResponses
            AnalyzePerformance
            ReplicationReport
        end
    end

    %% 4. Styling
    classDef entry fill:#337ab7,stroke:#2e6da4,color:#fff;
    classDef layer_orange fill:#f0ad4e,stroke:#eea236,color:#333;
    classDef layer_green fill:#5cb85c,stroke:#4cae4c,color:#fff;
    classDef script fill:#5bc0de,stroke:#46b8da,color:#fff;
    classDef danger fill:#d9534f,stroke:#d43f3a,color:#fff;
    classDef artifact fill:#f0f0f0,stroke:#ccc,stroke-width:2px,stroke-dasharray: 5 5;

