graph LR

    %%{
      init: {
        'theme': 'base',
        'themeVariables': {
          'fontSize': '12px',
          'nodePadding': '5px'
        }
      }
    }%%

    %% --- Main Processing Pipeline (Vertical) ---
    subgraph "Main Data Pipeline"
        direction TB
        
        subgraph "Input Data"
            A1(personalities_db_1-5000.txt)
            A2(base_query.txt)
            A3(config.ini)
        end

        subgraph "Stage 1: Query Generation"
            B(build_queries.py)
            B --> C[llm_query_XXX.txt]
        end
        
        subgraph "Stage 2: LLM Interaction"
            D(run_llm_sessions.py)
            D --> E[llm_response_XXX.txt]
        end
        
        subgraph "Stage 3: Response Processing"
            F(process_llm_responses.py)
            F --> G[all_scores.txt]
            F --> H[all_mappings.txt]
        end

        %% Connections within the main pipeline
        A1 & A2 & A3 --> B
        C --> D
        E --> F
    end

    %% --- Analysis Stage (To the Right) ---
    subgraph "Stage 4: Hierarchical Analysis"
        direction TB
        I(compile_results.py)
        J(run_anova.py)
        
        subgraph "Aggregation Loop"
            direction TB
            M(replication_report.txt) --> I;
            I --> K_rep[REPLICATION_results.csv];
            K_rep --> I;
            I --> K_exp[EXPERIMENT_results.csv];
            K_exp --> I;
            I --> K_final[final_summary_results.csv];
        end

        K_final --> J;
        J --> L[MASTER_ANOVA_DATASET.csv];
        J --> N((Plots & Log));
    end
    
    %% --- Cross-Stage Connections ---
    A3 --> O(config.ini.archived):::Data
    O & H --> I;
    
    classDef Data fill:#e6f3ff,stroke:#007bff
    classDef Script fill:#fff0e6,stroke:#ff7f0e
    class A1,A2,A3,C,E,G,H,K_rep,K_exp,K_final,L,M,N,O Data
    class B,D,F,I,J Script