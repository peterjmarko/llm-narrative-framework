graph TD
    classDef scriptStyle fill:#fff2cc,stroke:#d6b656,stroke-width:2px
    classDef utilStyle fill:#e6e6fa,stroke:#333,stroke-width:2px
    classDef orchestratorStyle fill:#cce5ff,stroke:#333,stroke-width:2px

    subgraph "Orchestration Scripts"
        P[prepare_data.ps1]
    end

    subgraph "Main Data Preparation Pipeline"
        A[src/fetch_adb_data.py]
        B[src/find_wikipedia_links.py]
        B2[src/validate_wikipedia_pages.py]
        C[src/select_eligible_candidates.py]
        D["src/generate_eminence_scores.py<br/>(Uses LLM)"]
        E["src/generate_ocean_scores.py<br/>(Uses LLM)"]
        F[src/select_final_candidates.py]
        G[src/prepare_sf_import.py]
        H[src/create_subject_db.py]
        I[src/generate_personalities_db.py]
    end
    
    P --> A
    P --> B
    P --> B2
    P --> C
    P --> D
    P --> E
    P --> F
    P --> G
    P --> H
    P --> I

    %% Invisible links to force vertical stacking
    A ~~~ B ~~~ B2 ~~~ C ~~~ D ~~~ E ~~~ F ~~~ G ~~~ H ~~~ I
    
    subgraph Delineation Processing
        J["src/neutralize_delineations.py<br/>(Uses LLM)"]
    end

    J --> I
    J --> H

    subgraph Shared Utilities
        K(src/id_encoder.py)
    end

    G -.-> K
    H -.-> K

    %% Apply Styles
    class P orchestratorStyle
    class A,B,B2,C,D,E,F,G,H,I,J scriptStyle
    class K utilStyle