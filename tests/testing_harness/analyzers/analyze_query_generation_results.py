#!/usr/bin/env python3
#-*- coding: utf-8 -*-
#
# Personality Matching Experiment Framework
# Copyright (C) 2025 Peter J. Marko
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
# Filename: tests/testing_harness/analyzers/analyze_query_generation_results.py

"""
Analyzer for the Query Generation & Randomization Integrity Test.

This script performs statistical validation on a large set of trial manifests
generated by the `validate_query_generation.ps1` harness.

It verifies two key properties:
1.  Determinism of the 'correct' mapping strategy.
2.  Non-determinism of the 'random' mapping strategy.
"""
import argparse
from pathlib import Path

# ANSI color codes
class Colors:
    GREEN = '\033[92m'
    RED = '\033[91m'
    RESET = '\033[0m'

def validate_correct_strategy(manifests):
    """Asserts that all 'correct' manifests are identical."""
    print("  Validating 'correct' strategy for determinism...")
    if not manifests:
        raise ValueError("No manifests found for 'correct' strategy.")

    first_content_lines = manifests[0].read_text(encoding="utf-8").strip().splitlines()
    for manifest_path in manifests[1:]:
        current_content_lines = manifest_path.read_text(encoding="utf-8").strip().splitlines()
        assert first_content_lines == current_content_lines, \
            f"  -> {Colors.RED}FAIL:{Colors.RESET} 'correct' strategy is not deterministic. Mismatch found in {manifest_path.name}"
    print(f"{Colors.GREEN}  -> OK: 'correct' strategy is deterministic.{Colors.RESET}")


def validate_random_strategy(manifests):
    """Asserts that the 'random' strategy produces different results."""
    print("  Validating 'random' strategy for non-determinism...")
    if not manifests:
        raise ValueError("No manifests found for 'random' strategy.")

    first_content_lines = manifests[0].read_text(encoding="utf-8").strip().splitlines()
    is_non_deterministic = False
    for manifest_path in manifests[1:]:
        current_content_lines = manifest_path.read_text(encoding="utf-8").strip().splitlines()
        if first_content_lines != current_content_lines:
            is_non_deterministic = True
            break

    assert is_non_deterministic, \
        f"{Colors.RED}  -> FAIL: 'random' strategy appears deterministic. All generated manifests were identical.{Colors.RESET}"
    print(f"{Colors.GREEN}  -> OK: 'random' strategy is non-deterministic.{Colors.RESET}")


def main():
    """Main entry point for the analyzer."""
    parser = argparse.ArgumentParser(description="Validate query generation manifests.")
    parser.add_argument("--manifest-dir", type=Path, required=True,
                        help="Directory containing the generated trial manifests.")
    args = parser.parse_args()

    manifest_dir = args.manifest_dir
    if not manifest_dir.is_dir():
        raise FileNotFoundError(f"Manifest directory not found: {manifest_dir}")

    # The python script appends 'manifest.txt' to the prefix.
    correct_manifests = sorted(manifest_dir.glob("trial_correct_*_manifest.txt"))
    random_manifests = sorted(manifest_dir.glob("trial_random_*_manifest.txt"))

    print(f"Found {len(correct_manifests)} 'correct' and {len(random_manifests)} 'random' manifests.")

    validate_correct_strategy(correct_manifests)
    validate_random_strategy(random_manifests)


if __name__ == "__main__":
    main()

# === End of tests/testing_harness/analyzers/analyze_query_generation_results.py ===
